# Instrucciones para GitHub Copilot - DYGSOM Fraud API

## Contexto del Proyecto

**Proyecto**: DYGSOM Fraud Scoring API  
**Framework**: FastAPI + Python 3.11  
**Database**: PostgreSQL 15 con Prisma  
**Cache**: Redis 7  
**ML**: scikit-learn + XGBoost  

## Fase Actual: DÃA 2 - Database Schema + Repository Layer

### Objetivos del DÃ­a 2

**Backend (ali1):**
1. Completar schema Prisma con todas las tablas
2. Implementar Repository Pattern
3. Implementar Service Layer bÃ¡sico
4. Crear seed script con 1000 transacciones

**ML (Alicia):**
1. Entrenar modelo baseline XGBoost
2. Feature extraction completo
3. Accuracy >85%

---

## ğŸš« GUARDRAILS OBLIGATORIOS

### Prohibido (NUNCA usar):
- âŒ `any` type en Python (usar type hints siempre)
- âŒ Magic numbers o strings (usar constantes)
- âŒ `print()` statements (usar logging)
- âŒ Hardcoded secrets o credentials
- âŒ SQL queries sin parametrizar
- âŒ Passwords sin hashear
- âŒ Retornar passwords en responses
- âŒ Operaciones blocking (usar async)

### Obligatorio (SIEMPRE usar):
- âœ… Type hints en todas las funciones
- âœ… Pydantic para validaciÃ³n
- âœ… Async/await para operaciones I/O
- âœ… Logging estructurado
- âœ… Docstrings en funciones pÃºblicas
- âœ… Exception handling apropiado
- âœ… Tests para nuevo cÃ³digo

---

## ğŸ“ Convenciones de Nomenclatura

### Archivos
```python
# âœ… Correcto: snake_case
transaction_repository.py
fraud_service.py
create_transaction_dto.py

# âŒ Incorrecto
TransactionRepository.py
fraudService.py
```

### Clases
```python
# âœ… Correcto: PascalCase
class TransactionRepository:
class FraudService:
class CreateTransactionDto:
```

### Funciones y Variables
```python
# âœ… Correcto: snake_case
def get_transaction_by_id():
async def score_transaction():
customer_email = "test@example.com"
```

### Constantes
```python
# âœ… Correcto: UPPER_SNAKE_CASE
MAX_TRANSACTION_AMOUNT = 1000000
DEFAULT_FRAUD_THRESHOLD = 0.5
CACHE_TTL_SECONDS = 3600
```

---

## ğŸ—ï¸ Arquitectura - Repository Pattern

### Estructura de Archivos
```
src/
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_repository.py
â”‚   â””â”€â”€ transaction_repository.py
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ fraud_service.py
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ transaction_schemas.py
â””â”€â”€ models/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ transaction.py
```

### Template Repository
```python
from typing import Optional, List
from prisma import Prisma
from src.models.transaction import Transaction

class TransactionRepository:
    def __init__(self, prisma: Prisma):
        self.prisma = prisma
    
    async def find_by_id(self, transaction_id: str) -> Optional[Transaction]:
        """Find transaction by ID"""
        result = await self.prisma.transaction.find_unique(
            where={"transaction_id": transaction_id}
        )
        return Transaction(**result) if result else None
    
    async def create(self, data: dict) -> Transaction:
        """Create new transaction"""
        result = await self.prisma.transaction.create(data=data)
        return Transaction(**result)
    
    async def find_all(self, skip: int = 0, limit: int = 100) -> List[Transaction]:
        """Find all transactions with pagination"""
        results = await self.prisma.transaction.find_many(
            skip=skip,
            take=limit,
            order={"created_at": "desc"}
        )
        return [Transaction(**r) for r in results]
```

### Template Service
```python
from typing import Dict
import logging
from src.repositories.transaction_repository import TransactionRepository

logger = logging.getLogger(__name__)

class FraudService:
    def __init__(self, transaction_repo: TransactionRepository):
        self.transaction_repo = transaction_repo
    
    async def score_transaction(self, data: dict) -> Dict:
        """Score transaction for fraud risk"""
        logger.info(f"Scoring transaction: {data.get('transaction_id')}")
        
        # TODO: Implement fraud scoring logic
        
        return {
            "fraud_score": 0.0,
            "risk_level": "LOW",
            "recommendation": "APPROVE"
        }
```

### Template DTO (Pydantic)
```python
from pydantic import BaseModel, Field, validator
from typing import Optional
from datetime import datetime

class CustomerData(BaseModel):
    id: Optional[str] = None
    email: str = Field(..., regex=r'^[\w\.-]+@[\w\.-]+\.\w+$')
    phone: Optional[str] = None
    ip_address: str

class CreateTransactionDto(BaseModel):
    transaction_id: str
    amount: float = Field(..., gt=0, le=1000000)
    currency: str = Field(default="PEN")
    timestamp: datetime
    customer: CustomerData
    
    @validator('amount')
    def amount_must_be_positive(cls, v):
        if v <= 0:
            raise ValueError('Amount must be positive')
        return v
```

---

## ğŸ” Reglas de Negocio - DYGSOM

### Transacciones
1. **Monto mÃ­nimo**: 1.00 PEN
2. **Monto mÃ¡ximo**: 1,000,000 PEN
3. **Moneda default**: PEN (PerÃº)
4. **Todas las transacciones se almacenan** (incluso las declinadas)

### Fraud Scoring
1. **Fraud score**: 0.0 - 1.0 (probabilidad de fraude)
2. **Risk levels**:
   - LOW: score < 0.3
   - MEDIUM: 0.3 <= score < 0.5
   - HIGH: 0.5 <= score < 0.8
   - CRITICAL: score >= 0.8
3. **Recommendations**:
   - APPROVE: Para LOW y algunos MEDIUM
   - REVIEW: Para MEDIUM y algunos HIGH
   - DECLINE: Para HIGH y CRITICAL

### Performance Targets
- **Latencia**: <100ms (p95)
- **Throughput**: >100 req/s
- **Accuracy**: >90%

---

## ğŸ“Š Database Schema (Prisma)
```prisma
model Transaction {
  id                 String   @id @default(uuid())
  transaction_id     String   @unique
  amount             Decimal  @db.Decimal(12, 2)
  currency           String   @default("PEN")
  timestamp          DateTime @default(now())
  
  // Customer
  customer_id        String?
  customer_email     String?
  customer_ip        String?
  
  // Payment
  card_bin           String?
  card_last4         String?
  card_brand         String?
  
  // Fraud Detection
  fraud_score        Decimal? @db.Decimal(5, 4)
  risk_level         String?
  decision           String?
  
  created_at         DateTime @default(now())
  
  @@index([customer_email])
  @@index([fraud_score])
}
```

---

## âœ… Checklist por Tarea

### Repository âœ… COMPLETADO
- [x] Type hints en todos los mÃ©todos (16 mÃ©todos async con type hints)
- [x] Docstrings explicativos (todas las funciones documentadas)
- [x] Exception handling (try/except en operaciones crÃ­ticas)
- [x] Async/await usado correctamente (100% de mÃ©todos I/O)
- [x] Retorna domain models (dicts tipados con Optional)

**Archivos implementados:**
- `src/repositories/base_repository.py` - 6 mÃ©todos CRUD base
- `src/repositories/transaction_repository.py` - 9 mÃ©todos especializados

### Service âœ… COMPLETADO
- [x] Business logic clara y separada (fraud scoring pipeline)
- [x] Logging de operaciones importantes (13 logger calls)
- [x] Validaciones de negocio (risk levels, thresholds)
- [x] Manejo de errores apropiado (try/except con logging)

**Archivos implementados:**
- `src/services/fraud_service.py` - FraudService completo

### DTO âœ… COMPLETADO
- [x] Pydantic BaseModel usado (4 DTOs principales)
- [x] Validadores custom si necesario (11 @validator decorators)
- [x] Type hints correctos (todos los campos tipados)
- [x] Ejemplos en docstrings (documentaciÃ³n completa)

**Archivos implementados:**
- `src/schemas/transaction_schemas.py` - 4 DTOs con validaciÃ³n

### Seed Script âœ… COMPLETADO
- [x] Script funcional (1000 transacciones generadas)
- [x] Datos realistas (Faker con locale espaÃ±ol)
- [x] DistribuciÃ³n correcta (80% LOW, 5% MEDIUM, 9% HIGH, 5% CRITICAL)
- [x] Sin errores (ejecutado exitosamente)

**Archivos implementados:**
- `src/scripts/seed_transactions.py` - Seed completo

### Code Quality âœ… COMPLETADO
- [x] Black formatter aplicado (6 archivos reformateados)
- [x] Flake8 linter sin errores (0 errors, 0 warnings)
- [x] Sin patrones prohibidos (0 print, 0 magic numbers)
- [x] Type hints 100% cobertura (15 archivos Python)
- [x] Async/await correcto (todas las operaciones I/O)

**Validaciones completadas:**
- `validations/verify_day2.py` - 12/12 checks âœ…
- `validations/CODE_QUALITY_REPORT.md` - Reporte completo

---

## ğŸ¯ Prioridades del DÃ­a 2 - âœ… COMPLETADO

1. **Alta**: Repository + Service layer âœ…
   - BaseRepository con 6 mÃ©todos CRUD
   - TransactionRepository con 9 mÃ©todos especializados
   - FraudService con pipeline completo
   
2. **Alta**: Seed script funcional âœ…
   - 1000 transacciones generadas exitosamente
   - DistribuciÃ³n realista de risk levels
   - Datos con Faker en espaÃ±ol
   
3. **Media**: DTOs completos âœ…
   - 4 DTOs principales (Customer, Payment, Create, Response)
   - 11 validadores custom
   - ValidaciÃ³n completa de datos
   
4. **Baja**: Tests (viene en DÃ­a 5) â³
   - Framework pytest configurado
   - Estructura de directorios lista
   - Pendiente para DÃ­a 5 segÃºn roadmap

---

## ğŸ“Š Estado del DÃ­a 2

**Backend (ali1): 100% COMPLETADO âœ…**
- âœ… Schema Prisma con 4 tablas
- âœ… Migraciones ejecutadas (prisma db push)
- âœ… Repository Pattern implementado
- âœ… Service Layer completo
- âœ… Seed script funcional (1000 transacciones)
- âœ… Code quality 100% (Black + Flake8)

**PrÃ³ximo paso: DÃ­a 3 - FastAPI Endpoints + ML Integration**

---

## ğŸ“ Estructura Final del Proyecto

```
dygsom-fraud-api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ repositories/          âœ… COMPLETADO
â”‚   â”‚   â”œâ”€â”€ base_repository.py
â”‚   â”‚   â””â”€â”€ transaction_repository.py
â”‚   â”œâ”€â”€ services/              âœ… COMPLETADO
â”‚   â”‚   â””â”€â”€ fraud_service.py
â”‚   â”œâ”€â”€ schemas/               âœ… COMPLETADO
â”‚   â”‚   â””â”€â”€ transaction_schemas.py
â”‚   â””â”€â”€ scripts/               âœ… COMPLETADO
â”‚       â””â”€â”€ seed_transactions.py
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma          âœ… COMPLETADO (4 tablas)
â”œâ”€â”€ validations/               âœ… NUEVA CARPETA
â”‚   â”œâ”€â”€ verify_day2.py
â”‚   â”œâ”€â”€ CODE_QUALITY_REPORT.md
â”‚   â””â”€â”€ README.md
â”œâ”€â”€ requirements.txt           âœ… ACTUALIZADO (black, flake8)
â””â”€â”€ .copilot-instructions.md   âœ… ACTUALIZADO
```

---

## ğŸ’¡ Tips para Copilot

- Lee estos archivos primero antes de generar cÃ³digo
- Sigue las convenciones sin excepciÃ³n
- Pregunta si algo no estÃ¡ claro
- Usa los templates como base
- Prioriza cÃ³digo simple y legible