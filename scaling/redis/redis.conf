# ============================================================================
# DYGSOM Fraud API - Redis Configuration for L2 Cache
# ============================================================================
# This configuration optimizes Redis for use as a shared L2 cache across
# multiple API instances in a scaled deployment.
#
# Performance targets:
#   - Cache hit rate: >90%
#   - Cache latency: <1ms
#   - Memory usage: <1GB
#   - High availability with persistence
# ============================================================================

# Bind to all interfaces (Docker network)
bind 0.0.0.0

# Protected mode disabled (within Docker network)
protected-mode no

# Default port
port 6379

# TCP listen backlog
tcp-backlog 511

# Close connection after N seconds of idleness
timeout 300

# TCP keepalive
tcp-keepalive 60

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================

# Max number of connected clients
maxclients 10000

# Memory management (configured via command line in docker-compose)
# maxmemory 1gb
# maxmemory-policy allkeys-lru

# Lazy freeing
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Active defragmentation
activedefrag yes
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# ============================================================================
# PERSISTENCE
# ============================================================================

# RDB snapshots (configured via command line in docker-compose)
# save 900 1    # After 900 sec if at least 1 key changed
# save 300 10   # After 300 sec if at least 10 keys changed
# save 60 10000 # After 60 sec if at least 10000 keys changed

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# AOF (Append Only File) - disabled for cache use case
appendonly no

# ============================================================================
# LOGGING
# ============================================================================

loglevel notice
logfile ""

# ============================================================================
# SECURITY
# ============================================================================

# No password required (within private Docker network)
# requirepass change_in_production

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# ============================================================================
# REPLICATION (for future HA setup)
# ============================================================================

# replica-read-only yes
# replica-serve-stale-data yes

# ============================================================================
# MEMORY OPTIMIZATION
# ============================================================================

# Hash optimization (reduce memory for small hashes)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List optimization
list-max-ziplist-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512

# Sorted set optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog sparse representation
hll-sparse-max-bytes 3000

# ============================================================================
# ADVANCED SETTINGS
# ============================================================================

# Disable Lua scripting timeout (default: 5000ms)
lua-time-limit 5000

# Slow log
slowlog-log-slower-than 10000  # 10ms
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 100  # 100ms

# Event notification (useful for monitoring)
notify-keyspace-events ""

# ============================================================================
# NOTES
# ============================================================================
# 1. Memory Policy: allkeys-lru
#    - Evict least recently used keys when max memory reached
#    - Good for cache use case
#    - Alternative: volatile-lru (only evict keys with TTL)
#
# 2. Persistence Strategy:
#    - RDB snapshots for backup (15min, 5min, 1min intervals)
#    - AOF disabled (cache data is not critical)
#    - Data can be regenerated from primary database
#
# 3. Performance:
#    - Lazy freeing reduces blocking operations
#    - Active defragmentation prevents memory fragmentation
#    - Optimized data structures for small values
#
# 4. Security:
#    - No password (within private Docker network)
#    - Dangerous commands disabled
#    - Consider adding password for production
#
# 5. Monitoring:
#    - Slow log for queries >10ms
#    - Latency monitoring for operations >100ms
#    - Use redis-cli --latency-history for testing
#
# ============================================================================
